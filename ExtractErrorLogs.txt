Sub ExtractErrorLogs()
    Dim folderPath As String
    Dim fileName As String
    Dim wbSource As Workbook
    Dim wsLog As Worksheet
    Dim wsDest As Worksheet
    Dim destRow As Long
    Dim keywords As Variant
    Dim key As Variant
    Dim foundCell As Range
    Dim firstAddress As String

    ' --- 1. フォルダ選択 (FileDialogを使用) ---
    With Application.FileDialog(msoFileDialogFolderPicker)
        .Title = "ログファイルが入ったフォルダを選択してください"
        If .Show = True Then
            folderPath = .SelectedItems(1) & "\"
        Else
            MsgBox "処理をキャンセルしました。"
            Exit Sub
        End If
    End With

    ' --- 2. 書き出し先の準備 ---
    Set wsDest = ThisWorkbook.Sheets("Sheet1")
    ' A列の最終行を確認して、次の行から書き込む
    destRow = wsDest.Cells(wsDest.Rows.Count, "A").End(xlUp).Row + 1
    If destRow = 1 Or wsDest.Cells(1, 1).Value = "" Then
        ' 見出しがない場合は作成
        wsDest.Range("A1:C1").Value = Array("ファイル名", "区分", "内容")
        destRow = 2
    End If

    ' --- 3. メイン処理 ---
    keywords = Array("ERROR", "EXCEPTION")
    fileName = Dir(folderPath & "*.xls*") ' エクセルファイルを検索

    Application.ScreenUpdating = False ' 画面更新を止めて高速化

    Do While fileName <> ""
        ' 自分自身は開かない
        If fileName <> ThisWorkbook.Name Then
            Set wbSource = Workbooks.Open(folderPath & fileName, ReadOnly:=True)
            
            ' 「ログ」シートがあるかチェック
            On Error Resume Next
            Set wsLog = wbSource.Sheets("ログ")
            On Error GoTo 0
            
            If Not wsLog Is Nothing Then
                ' キーワードごとに検索
                For Each key In keywords
                    ' 完全一致ではなく「含む」で検索、大文字小文字を区別する
                    Set foundCell = wsLog.Cells.Find(What:=key, LookAt:=xlPart, MatchCase:=True)
                    
                    If Not foundCell Is Nothing Then
                        firstAddress = foundCell.Address
                        Do
                            ' 書き出し
                            wsDest.Cells(destRow, 1).Value = fileName
                            wsDest.Cells(destRow, 2).Value = key
                            foundCell.Copy wsDest.Cells(destRow, 3) ' 書式ごとコピー
                            
                            destRow = destRow + 1
                            Set foundCell = wsLog.Cells.FindNext(foundCell)
                        Loop While Not foundCell Is Nothing And foundCell.Address <> firstAddress
                    End If
                Next key
            End If
            
            wbSource.Close SaveChanges:=False
            Set wsLog = Nothing
        End If
        fileName = Dir() ' 次のファイルを探す
    Loop

    Application.ScreenUpdating = True
    MsgBox "すべてのファイルの確認が完了しました！", vbInformation
End Sub