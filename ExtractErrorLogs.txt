Sub ExtractErrorLogs()
    Dim folderPath As String
    Dim fileName As String
    Dim wbSource As Workbook
    Dim wsLog As Worksheet
    Dim wsDest As Worksheet
    Dim destRow As Long
    Dim keywords As Variant
    Dim key As Variant
    Dim foundCell As Range
    Dim firstAddress As String

    ' --- 1. フォルダ選択 ---
    With Application.FileDialog(msoFileDialogFolderPicker)
        .Title = "ログファイルが入ったフォルダを選択してください"
        If .Show = True Then
            folderPath = .SelectedItems(1) & "\"
        Else
            Exit Sub
        End If
    End With

    ' --- 2. 書き出し先の準備 (Sheet1) ---
    Set wsDest = ThisWorkbook.Sheets("Sheet1")
    ' 見出しの設定
    wsDest.Range("A1:E1").Value = Array("ブック名", "シート名", "セル番号", "区分", "内容")
    
    ' 2行目以降の既存データをクリア（新しく抽出する場合）
    wsDest.Rows("2:" & wsDest.Rows.Count).Clear
    destRow = 2

    ' --- 3. メイン処理 ---
    keywords = Array("ERROR", "EXCEPTION")
    fileName = Dir(folderPath & "*.xls*")

    Application.ScreenUpdating = False

    Do While fileName <> ""
        If fileName <> ThisWorkbook.Name Then
            ' 読み取り専用で開く
            Set wbSource = Workbooks.Open(folderPath & fileName, ReadOnly:=True)
            
            On Error Resume Next
            Set wsLog = wbSource.Sheets("ログ")
            On Error GoTo 0
            
            If Not wsLog Is Nothing Then
                For Each key In keywords
                    ' 検索実行
                    Set foundCell = wsLog.Cells.Find(What:=key, LookAt:=xlPart, MatchCase:=True)
                    
                    If Not foundCell Is Nothing Then
                        firstAddress = foundCell.Address
                        Do
                            ' A:ブック名
                            wsDest.Cells(destRow, 1).Value = fileName
                            ' B:シート名
                            wsDest.Cells(destRow, 2).Value = wsLog.Name
                            ' C:セル番号 (例: $A$10)
                            wsDest.Cells(destRow, 3).Value = foundCell.Address
                            ' D:区分
                            wsDest.Cells(destRow, 4).Value = key
                            ' E:対象セルを貼り付け (書式込)
                            foundCell.Copy wsDest.Cells(destRow, 5)
                            
                            destRow = destRow + 1
                            Set foundCell = wsLog.Cells.FindNext(foundCell)
                        Loop While Not foundCell Is Nothing And foundCell.Address <> firstAddress
                    End If
                Next key
            End If
            
            wbSource.Close SaveChanges:=False
            Set wsLog = Nothing
        End If
        fileName = Dir()
    Loop

    Application.ScreenUpdating = True
    MsgBox "抽出が完了しました。合計 " & (destRow - 2) & " 件見つかりました。", vbInformation
End Sub